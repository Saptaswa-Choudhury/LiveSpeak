<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveSpeak - Speaker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #1a1a1a; }
        p { color: #666; }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            min-width: 180px;
        }
        #toggleButton { background-color: #007bff; }
        #toggleButton:hover { background-color: #0056b3; }
        #toggleButton.recording { background-color: #dc3545; }
        #toggleButton.recording:hover { background-color: #a71d2a; }
        #toggleButton:disabled { background-color: #6c757d; cursor: not-allowed; }
        #status { margin-top: 20px; font-weight: bold; height: 24px; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>LiveSpeak Broadcaster</h1>
        <p>Click the button below to start or stop captioning.</p>
        <button id="toggleButton">Start Captioning</button>
        <div id="status">Status: Idle</div>
    </div>

    <script>
        const toggleButton = document.getElementById('toggleButton');
        const statusDiv = document.getElementById('status');
        
        let socket;
        let mediaRecorder;
        let microphone;
        let isRecording = false;

        toggleButton.addEventListener('click', () => {
            toggleButton.disabled = true;
            if (isRecording) {
                stopCaptioning();
            } else {
                startCaptioning();
            }
            setTimeout(() => { toggleButton.disabled = false; }, 1000);
        });

        async function startCaptioning() {
            statusDiv.textContent = 'Status: Awaiting mic permission...';
            console.log('Requesting microphone access...');

            try {
                microphone = await navigator.mediaDevices.getUserMedia({ audio: true });
                statusDiv.textContent = 'Status: Mic acquired. Connecting...';
                console.log('Microphone access granted.');

                socket = new WebSocket(`ws://${window.location.host}/speak`);

                socket.onopen = () => {
                    console.log('WebSocket connected. Starting media recorder.');
                    statusDiv.textContent = 'Status: Captioning Live...';

                    const options = { mimeType: 'audio/webm; codecs=opus' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        console.error(`${options.mimeType} is not supported on this browser.`);
                        statusDiv.textContent = 'Error: Browser audio format not supported.';
                        stopCaptioning();
                        return;
                    }

                    mediaRecorder = new MediaRecorder(microphone, options);
                    
                    mediaRecorder.ondataavailable = async (event) => {
                        if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                            const arrayBuffer = await event.data.arrayBuffer();
                            // --- BROWSER-SIDE DIAGNOSTIC ---
                            console.log(`[BROWSER] Sending audio chunk of size: ${arrayBuffer.byteLength} bytes`);
                            socket.send(arrayBuffer);
                        }
                    };
                    
                    mediaRecorder.start(250);
                    isRecording = true;
                    toggleButton.textContent = 'Stop Captioning';
                    toggleButton.classList.add('recording');
                };

                socket.onclose = (event) => {
                    console.log('WebSocket connection closed.', event.code, event.reason);
                    stopCaptioning();
                };

                socket.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    statusDiv.textContent = 'Error: Connection failed.';
                    stopCaptioning();
                };

            } catch (micError) {
                console.error('Microphone access denied:', micError);
                statusDiv.textContent = 'Error: Microphone access denied.';
                toggleButton.disabled = false;
            }
        }

        function stopCaptioning() {
            console.log('Stopping captioning...');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            if (microphone) {
                microphone.getTracks().forEach(track => track.stop());
            }
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.close();
            }
            
            isRecording = false;
            toggleButton.textContent = 'Start Captioning';
            toggleButton.classList.remove('recording');
            statusDiv.textContent = 'Status: Idle';
        }
    </script>
</body>
</html>

